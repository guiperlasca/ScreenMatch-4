<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenmatch - Perfil</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/perfil.css">
</head>
<body>
    <header class="cabecalho">
        <a href="/" class="cabecalho__logo">
            <img src="./img/logo.png" alt="Logo ScreenMatch">
            <h1>Screen match</h1>
        </a>
        <div class="cabecalho__opcoes">
            <button id="logout-button" class="botao botao-secundario">Logout</button>
        </div>
    </header>

    <main class="conteudo-principal">
        <div class="perfil-container">
            <h2>Meu Perfil</h2>

            <section id="favoritos-container">
                <h3>Minhas Séries Favoritas</h3>
                <div id="favoritos-lista" class="lista"></div>
            </section>

            <section id="reviews-container">
                <h3>Minhas Reviews</h3>
                <div id="reviews-lista"></div>
            </section>
        </div>
    </main>

    <script type="module">
        import getDados from './scripts/getDados.js';
        import { isUserLoggedIn, logout } from './scripts/auth.js';

        document.addEventListener('DOMContentLoaded', () => {
            if (!isUserLoggedIn()) {
                window.location.href = '/login.html';
                return;
            }

            document.getElementById('logout-button').addEventListener('click', logout);

            carregarFavoritos();
            carregarReviews();
        });

        function carregarFavoritos() {
            const listaFavoritos = document.getElementById('favoritos-lista');
            getDados('/usuarios/meus-favoritos')
                .then(data => {
                    if(data.length === 0) {
                        listaFavoritos.innerHTML = '<p>Você ainda não favoritou nenhuma série.</p>';
                        return;
                    }
                    const listaHTML = data.map(serie => `
                        <li class="lista__item">
                            <a href="/detalhes.html?id=${serie.id}">
                                <img src="${serie.poster}" alt="${serie.titulo}">
                            </a>
                        </li>
                    `).join('');
                    listaFavoritos.innerHTML = listaHTML;
                });
        }

        function carregarReviews() {
            const listaReviews = document.getElementById('reviews-lista');
            getDados('/usuarios/meus-reviews')
                .then(data => {
                    if(data.length === 0) {
                        listaReviews.innerHTML = '<p>Você ainda não escreveu nenhuma review.</p>';
                        return;
                    }
                    const listaHTML = data.map(review => {
                        let ratingStars = '';
                        for (let i = 1; i <= 5; i++) {
                            const isFilled = i <= review.avaliacao ? 'filled' : '';
                            ratingStars += `<span class="material-symbols-outlined ${isFilled}">star</span>`;
                        }
                        return `
                            <div class="review">
                                <div class="review__header">
                                    <div class="review__rating">${ratingStars}</div>
                                    <span class="review__date">${new Date(review.data).toLocaleDateString()}</span>
                                </div>
                                <p class="review__texto">${review.texto}</p>
                            </div>
                        `;
                    }).join('');
                    listaReviews.innerHTML = listaHTML;
                });
        }
    </script>
</body>
</html>
